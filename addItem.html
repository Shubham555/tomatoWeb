<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tomato - Login Form</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<link href="css/main.css" rel="stylesheet" />
 
</head>
<body>
<div class="container"><br><br>

<!-- Modal HTML -->
			<div class="shadow_card">
                <form action="/examples/actions/confirmation.php" method="post">
					<!--<h1 class="text1">TOMATO</h1>-->
					<img src="img/logo_tomato.png" style="width: 300px;">
                    <p class="text label_text" style="margin-top: 0px;margin-bottom: 0px;">Add Item</p>
                 <div class="container">   
                <div class="row">
                    <div class="col-12" style="padding-bottom: 20px;">
                        <div class="container">
                          <div class="row">
                          <div class="col-lg-4 col-12 imgUp text-left">
                            <div class="imagePreview"></div>
                                <label class="d-block h-25 input100">
                                    Upload Picture <i class="fa fa-plus imgAdd"></i><input type="file" name="profilePic" class="uploadFile img" value="Upload Photo" style="width: 0px;height: 0px;overflow: hidden;">
                                </label>
                          </div><!-- col-2 -->                          
                         </div><!-- row -->
                        </div><!-- container -->
                    </div>
                    <br><br>
				  <div class="col-xs-4 col-sm-4 col-md-4">
					<div class="form-group"><b>Menu Item <span class="text-danger">*</span></b>
						 <input type="text" id="name" class="form-control" onfocusout="validator(this)" required>
                         <span for="name" style="font-family: Poppins-Regular; font-size: 13px; color: #DC567E;"></span>
                    </div>
				  </div> 

				  <div class="col-xs-3 col-sm-3 col-md-3">
					<div class="form-group">
                        <label for="menuOptions" class="mb-0"><strong>Menu Options <span class="text-danger">*</span></strong></label>
                        <select class="form-control" id="menuOptions">
                          
                        </select>
                    </div>
				</div> 

				<div class="col-xs-5 col-sm-5 col-md-5">
					<div class="form-group"><b>Enter Price <span class="text-danger">*</span></b>
						<input type="number" id="price" class="form-control" onfocusout="validator(this)" required>
                        <span for="price" style="font-family: Poppins-Regular; font-size: 13px; color: #DC567E;"></span>
                    </div>
				</div> 
		   </div>
		   
		      <div class="row">
		         <div class="col-xs-4 col-sm-4 col-md-4">
					<div class="form-group"><b>Menu Description</b>
				  <input type="text" class="form-control" id="description">
			      </div>
		        </div> 
			 </div>
			 
			 
 
		<div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6">
                <div class="form-group"><b class="label_text">Select Type</b> <br><br>
                    <input type="radio" name="type" id="veg" value="Veg"  checked="">&nbsp;
                      <label for="veg">Veg</label>
                    <input type="radio" name="type" id="nonveg" value="Non-Veg">&nbsp;
                       <label for="nonveg">Non Veg</label>&nbsp;
                      <input type="checkbox" name="type" id="vegan" value="vegan">&nbsp;
                        <label for="vegan">Vegan</label>&nbsp;
                </div>
            </div>
	</div>
 
    <div class="row">
        <div class="col-12">
             <b class="label_text">Ingredients Name</b> <br><br>
                
            </div>
            <div class="input-group mb-3 col-6">
                <br>
                <input type="text" id="newIngredient" class="form-control" placeholder="Enter Ingredients Name" aria-label="Recipient's username" aria-describedby="basic-addon2">
                <div class="input-group-append">
                  <span class="input-group-text" onclick="pushIngredient($('#newIngredient').val())" id="basic-addon2">Add</span>
                </div>
              </div>
              
        </div>

        <div class="row items">
        </div>
        <div class="form-group">
            <button type="button" onclick="submit_form()" class="btn btn-block">Submit</button>
            <a href="addCategory.html" class="btn btn-success">Add Category</a>
        </div>
</div> 
   


</div>
	
	   
</div>
  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-analytics.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-storage.js"></script>

  <script type="text/javascript" src="scripts/firebase.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>    
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script type="text/javascript" src="scripts/script.js"></script>
  <script type="text/javascript">
        // TODO: Add listener for the ingredients to list new ingredients added elsewhere
        // Check if the User is logged in
        var url_string = window.location.href
        var url = new URL(url_string);
        var cat = url.searchParams.get("name");
        var itemName = url.searchParams.get("title");
        let user, menuOptions, ingredients, submitIngredients = {}, suggestIngredients = [], addedIngredients = [], img_url;
        isLoggedIn(function(response) {
            if (response.status === 'Success') {
                user = response.user;
                console.log(user.uid);
                // Get the menu options
                getCategory(user.uid, function(response) {
                    menuOptions = response.items;
                    getIngredients(function(response) {
                        ingredients = response.items;
                        $(function() {
                            // Load the options
                            menuOptions.forEach(function(menuOption) {
                                let option = null;
                                if (cat === menuOption.name) {
                                    option = $('<option selected=""></option>').val(menuOption.name).text(menuOption.name);
                                } else {
                                    option = $('<option></option>').val(menuOption.name).text(menuOption.name);
                                }
                                $('select#menuOptions').append(option);
                            });

                            ingredients.forEach(function(ingredient) {
                                suggestIngredients.push(ingredient.name);
                            });

                            $('#newIngredient').autocomplete({
                              source: suggestIngredients
                            });

                            if (itemName) {
                                menuItem(user.uid, cat, itemName, function(response) {
                                    let item = response.item;
                                    console.log(item);
                                    if (item.image_url) {
                                        $('.imagePreview').css('background-image', 'url(' + item.image_url + ')');
                                        img_url = item.image_url;
                                    }
                                    $('#name').val(item.name);
                                    $('#price').val(item.price);
                                    $('#description').val(item.description);
                                    if (item.menu_type === 'Veg') {
                                        $('#veg').prop('checked', true);
                                    } else {
                                        $('#nonveg').prop('checked', true);
                                    }
                                    $('input#vegan').prop('checked', item.is_vegan);
                                    for (let ingredient in item.ingredients) {
                                        pushIngredient(ingredient);
                                    };
                                });                                
                            }
                        });                        
                    });
                });
            }
        });

        function findIn(addedIngredients, ingredient) {
            addedIngredients.some(function(element, i) {
                console.log(ingredient.toLowerCase(), element.toLowerCase())
                if (ingredient.toLowerCase() === element.toLowerCase()) {
                    return i;
                } else {
                    return -1;
                }
            });
        }

        function pushIngredient(ingredient) {
            let index = -1;
            addedIngredients.some(function(element, i) {
                if (ingredient.toLowerCase() === element.toLowerCase()) {
                    // Warning here
                    index = i
                }
            });
            if (index === -1) {
                addedIngredients.push(ingredient);
                let name = $('<div></div>').addClass('col-6 name').text(ingredient);
                let delBtn = $('<div></div>').addClass('col-6 text-right delete').text('Delete');
                let row = $('<div></div>').addClass('row').append(name, delBtn);
                let enclosure = $('<div></div>').addClass('col-4 item').html(row);

                $('.row.items').append(enclosure);
            }
        }

        async function submit_form() {
            console.log($('#name'), $('#price'));
            if (!validator($('#name')[0]) || !validator($('#price')[0]))
                return false;
            addedIngredients.forEach(function(ingredient) {
                if (suggestIngredients.includes(ingredient)) {
                    let add = ingredients.find(x => x.name === ingredient);
                    submitIngredients[add.name] = add.is_allergent;
                } else {
                    addIngredient(ingredient, function(response) {
                        if (response === 'Success') {
                            submitIngredients[ingredient] = false;
                        }
                    });
                }
            });
            console.log(submitIngredients);
            let category = $('#menuOptions').val();
            let data = {
                category: category,
                description: $('#description').val(),
                ingredients: submitIngredients,
                menu_type: $("input[name='type']:checked").val(),
                is_vegan: $('input#vegan').is(':checked'),
                name: $('#name').val(),
                price: $('#price').val(),
                timestamp: new Date()
            }            
            let imageFile = document.querySelector('input[type="file"]').files[0];
            if (imageFile) {
                let ext = imageFile.name.split('.').pop();
                let name = 'menus/' + category + '/' + $('#name').val() + '.' + ext;
                if (img_url) {
                    let path = img_url.split('/').pop().split('?')[0].replace(/%2F/g, '/').replace(/%20/g, ' ');
                    await deleteFile(path);
                }
                await storeImage(name, imageFile, async function(response) {
                    console.log('File Stored', response);
                    if (response.status === 'Success') {
                        console.log(data);
                        img_url = response.url;
                    }

                    if (img_url) {
                        data['image_url'] = img_url;
                    }

                    if (itemName) {
                        await deleteItemCollection(user.uid, category, itemName);
                    }
                    addItem(user.uid, category, data, function(response) {
                        if (response.status === 'Success')
                            window.location.href="menu.html";
                    });                    
                });
            } else {
            
                if (img_url) {
                    data['image_url'] = img_url;
                }

                if (itemName) {
                    await deleteItemCollection(user.uid, category, itemName);
                }
                addItem(user.uid, category, data, function(response) {
                    if (response.status === 'Success')
                        window.location.href="menu.html";
                });
            }
        }

        $(function() {
            $('.row.items').on('click', '.delete', function() {
                var name = $(this).closest('.item').find('.name').text();
                var index = addedIngredients.indexOf(name);
                if (index > -1) {
                    addedIngredients.splice(index, 1);
                    $(this).closest('.item').remove();
                }
            });
            $(document).on("change",".uploadFile", function()
            {
                console.log("yes");
                    var uploadFile = $(this);
                var files = !!this.files ? this.files : [];
                if (!files.length || !window.FileReader) return; // no file selected, or no FileReader support

                if (/^image/.test( files[0].type)){ // only image file
                    var reader = new FileReader(); // instance of the FileReader
                    reader.readAsDataURL(files[0]); // read the local file

                    reader.onloadend = function(){ // set image data as background of div
                        //alert(uploadFile.closest(".upimage").find('.imagePreview').length);
        uploadFile.closest(".imgUp").find('.imagePreview').css("background-image", "url("+this.result+")");
                    }
                }

            });            
        })        
  </script>              
</body>
</html>